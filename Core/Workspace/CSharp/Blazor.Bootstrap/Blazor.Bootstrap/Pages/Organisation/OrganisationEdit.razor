@page "/organisation/edit/{id}"
@attribute [Authorize]
@inject IDatabase Database
@inject Workspace Workspace
@inject NavigationManager NavigationManager

@if (organisation != null)
{
    <AllorsBSForm Model="@organisation" OnValidSubmit="@HandleValidSubmit">
        <ValidationSummary />

        <BSRow>
            <AllorsInput RoleType="@M.Organisation.Name" />
        </BSRow>

        <BSRow>
            <BSFormGroup>
                <BSButton type="submit">Submit</BSButton>
            </BSFormGroup>
        </BSRow>
    </AllorsBSForm>
}

@code {
    Context Context;

    [Parameter]
    public string id { get; set; }

    Organisation organisation;

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        this.Context = new Context(this.Database, this.Workspace);

        var pull = new Pull
        {
            ObjectId = id,
            Results = new[]
            {
                new Allors.Workspace.Data.Result
                {
                   Fetch = new Fetch
                   {
                       Include = new OrganisationNodeBuilder(
                           v=> {
                               v.Owner();
                           }),
                   }
            }
        }
        };

        var result = await this.Context.Load(pull);

        this.organisation = result.GetObject<Organisation>("Organisation");
    }

    public async System.Threading.Tasks.Task HandleValidSubmit()
    {
        var response = await this.Context.Save();
        if (!response.HasErrors)
        {
            this.NavigationManager.NavigateTo("/organisation/list");
        }
    }
}
